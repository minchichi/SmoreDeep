<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/Sly/1.6.1/sly.min.js"></script>
<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="assets/css/style_min.css">
<!-- jQuery ì¶”ê°€ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<title>S'MoreDeep</title>
</head>
<body>
	<input type="hidden" id="user_id"
		th:value="${session.user.get().getUserId()}">
	<div th:replace="~{header :: body}"></div>

	<div class="chat-container">
		<div class="chat-box" id="chat-box">
			<div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš” ìŠ¤ëª¨ì–´ë”¥ ì±—ë´‡ì…ë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ê°•ì˜
				ìŠ¤íƒ€ì¼ì´ë‚˜ ê´€ì‹¬ë¶„ì•¼ë¥¼ ë§í•´ì£¼ì‹œë©´ ê°•ì˜ë¥¼ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!</div>



			<div class="course-message">
				<div class="product-list" id="course-list"></div>
			</div>



		</div>
		<!-- ì‹œì‘ ì„ íƒ: ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë“œ or ì§ì ‘ì…ë ¥ -->
		<div class="quick-buttons" id="start-buttons">
			<button class="quick-button" onclick="startCategoryFlow()">ì¹´í…Œê³ ë¦¬
				ì„ íƒ</button>
			<button class="quick-button" onclick="unlockInput()">ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
		</div>

		<!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë‹¨ê³„ -->
		<div class="quick-buttons" id="step-category" style="display: none;">
			<button class="quick-button" onclick="selectCategory('í”„ë¡ íŠ¸ì—”ë“œ')">í”„ë¡ íŠ¸ì—”ë“œ</button>
			<button class="quick-button" onclick="selectCategory('ë°±ì—”ë“œ')">ë°±ì—”ë“œ</button>
			<button class="quick-button" onclick="selectCategory('í”„ë¡œê·¸ë˜ë°')">í”„ë¡œê·¸ë˜ë°</button>
		</div>

		<!-- ë‚œì´ë„ ì„ íƒ ë‹¨ê³„ -->
		<div class="quick-buttons" id="step-level" style="display: none;">
			<button class="quick-button" onclick="selectLevel('ì…ë¬¸')">ì…ë¬¸</button>
			<button class="quick-button" onclick="selectLevel('ì´ˆê¸‰')">ì´ˆê¸‰</button>
			<button class="quick-button" onclick="selectLevel('ì¤‘ê¸‰ ì´ìƒ')">ì¤‘ê¸‰
				ì´ìƒ</button>
		</div>

		<!-- ê°•ì˜ì‹œê°„ ì„ íƒ ë‹¨ê³„ -->
		<div class="quick-buttons" id="step-time" style="display: none;">
			<button class="quick-button" onclick="selectTime('1ì‹œê°„ ë¯¸ë§Œ')">1ì‹œê°„
				ë¯¸ë§Œ</button>
			<button class="quick-button" onclick="selectTime('1ì‹œê°„ ì´ìƒ')">1ì‹œê°„
				ì´ìƒ</button>
			<button class="quick-button" onclick="selectTime('3ì‹œê°„ ì´ìƒ')">3ì‹œê°„
				ì´ìƒ</button>
			<button class="quick-button" onclick="selectTime('5ì‹œê°„ ì´ìƒ')">5ì‹œê°„
				ì´ìƒ</button>
		</div>
		<div class="chat-input">
			<input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
			<button onclick="sendMessage()">ì „ì†¡</button>
		</div>

	</div>

	<div th:replace="~{footer :: body}"></div>

	<script>
let selectedCategory = "";
let selectedLevel = "";
let selectedTime = "";
let inputUnlocked = false;
const currentUserId = $("#user_id").val();




function addUserMessage(msg) {
	  $("#chat-box").append(`<div class="message user-message">${msg}</div>`);
	  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
	}


function addBotMessage(msg) {
  $("#chat-box").append(`<div class="message bot-message">${msg}</div>`);
  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
}

function startCategoryFlow() {
  $(".quick-buttons").hide();
  selectedCategory = "";
  selectedLevel = "";
  selectedTime = "";
  addBotMessage("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
  $("#step-category").show();
}

function selectCategory(category) {
  selectedCategory = category;
  addUserMessage(category);
  $("#step-category").hide();
  addBotMessage("ë‚œì´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
  $("#step-level").show();
}

function selectLevel(level) {
  selectedLevel = level;
  addUserMessage(level);
  $("#step-level").hide();
  addBotMessage("ê°•ì˜ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
  $("#step-time").show();
}

function selectTime(time) {
	  selectedTime = time;
	  addUserMessage(time + " ì„ íƒ");
	  $("#step-time").hide();
	  addBotMessage("ì„ íƒí•œ ì¡°ê±´ì„ ë°”íƒ•ìœ¼ë¡œ ê°•ì˜ë¥¼ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤...");
	  const userId = $("#user_id").val().trim();
	  const combined = `${selectedCategory} ${selectedLevel} ${selectedTime} ì¶”ì²œ`;

	  //ì„ í˜¸ ì €ì¥
	  $.ajax({
	    url: "/chatbot/preference",
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      userId: userId,
	      middleCategory: selectedCategory,
	      courseLevel: selectedLevel,
	      coursePlaytime: selectedTime,
	      userText: ""  // ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë“œì—ì„œëŠ” ë¹„ì›Œì¤˜ì•¼ í•¨
	    }),
	    success: function (prefIdx) {
	      console.log("ì„ í˜¸ ì €ì¥ ì„±ê³µ, prefIdx:", prefIdx);

	      //ì§ì ‘ sendToServer í˜¸ì¶œ (sendMessage ì•„ë‹˜)
	      sendToServer(combined, prefIdx);
	    },
	    error: function () {
	      addBotMessage("âŒ ì„ í˜¸ ì €ì¥ ì‹¤íŒ¨");
	    }
	  });
	}

function unlockInput() {
  inputUnlocked = true;
  $("#user-input").prop("disabled", false).focus();
  $(".quick-buttons").hide();
}

function sendMessage() {
	
	 if (!inputUnlocked) {
		    addBotMessage("ë¨¼ì € 'ì§ì ‘ ì…ë ¥í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
		    return;
		  }
  const userId = $("#user_id").val().trim();
  const msg = $("#user-input").val().trim();
  if (!msg) return;
  
  addUserMessage(msg);
  addBotMessage("ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ê°•ì˜ë¥¼ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤.");
  $("#user-input").val("");
  

//ì§ì ‘ì…ë ¥ ì‹œì—ë„ ì €ì¥ ìš”ì²­
  $.ajax({
    url: "/chatbot/preference",
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      userId: userId,
      middleCategory: "",
      courseLevel: "",
      coursePlaytime: "",
      userText: msg
    }),
    success: function (prefIdx) {
      console.log("ì§ì ‘ì…ë ¥ ì„ í˜¸ ì €ì¥ë¨:", prefIdx);

      // ì €ì¥ í›„ GPT ìš”ì²­
      sendToServer(msg, prefIdx);
    },
    error: function () {
      addBotMessage("âŒ ì§ì ‘ì…ë ¥ ì €ì¥ ì‹¤íŒ¨");
    }
  });
}

function sendQuickMessage(text) {
  $("#user-input").val(text);
  sendMessage();
}

function sendToServer(text, prefIdx) {
	  $.ajax({
	    url: "/chat/recommend",
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({ input: text }),
	    success: function (data) {
	    	console.log("GPT ì‘ë‹µ:", data); 
	      displayRecommendedCourses(data.results, prefIdx);  // prefIdx ë„˜ê²¨ì¤Œ
	      
	    },
	    
	    error: function () {
	      addBotMessage("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    }
	  });
	}
function getCourseIdxByTitle(title, callback) {
	  $.ajax({
	    url: "/course/find", 
	    type: "GET",
	    data: { courseNm: title },
	    success: function (data) {
	      if (data && data.courseIdx) {
	        callback(data.courseIdx);
	      } else {
	        console.warn("courseIdxë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", title);
	      }
	    },
	    error: function () {
	      console.error("âŒ courseIdx ì¡°íšŒ ì‹¤íŒ¨:", title);
	    }
	  });
	}

function displayRecommendedCourses(data, prefIdx) {
	  $(".quick-buttons").hide();
	 
	// ì¶”ì²œ ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° ì²˜ë¦¬
	  if (!data || data.length === 0) {
	    addBotMessage("ì í•©í•œ ê°•ì˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.");
	    
	    addBotMessage("ë‹¤ì‹œ ì¶”ì²œë°›ìœ¼ì‹œë ¤ë©´ ì•„ë˜ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!");
	    
	    const footerBtns = `
		    <div class="quick-buttons">
		      <button class="quick-button" onclick="startCategoryFlow()">ì¹´í…Œê³ ë¦¬ ì„ íƒí•˜ê¸°</button>
		      <button class="quick-button" onclick="unlockInput()">ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
		    </div>`;
		  $("#chat-box").append(footerBtns);
		  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

	 
	    
	    // recommended=0 ì €ì¥ ìš”ì²­
	    const currentUserId = $("#user_id").val();

$.ajax({
  url: "/chat/recommend/fail",
  type: "POST",
  contentType: "application/json",
  data: JSON.stringify({
    prefIdx: prefIdx,
    userId: currentUserId 
  }),
  success: function () {
    console.log("ì¶”ì²œ ì‹¤íŒ¨ ê¸°ë¡ ì €ì¥ ì„±ê³µ");
  },
  error: function () {
    console.log("âŒ ì¶”ì²œ ì‹¤íŒ¨ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨");
  }
});

	    return; // ë” ì´ìƒ ì•„ë˜ ì½”ë“œ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
	  }

	  //ìƒˆë¡œìš´ ìŠ¬ë¼ì´ë” DOM ìƒì„±
	  const courseMessageHTML = `
	    <div class="course-message">
	      <div class="product-list"></div>
	    </div>`;
	  $("#chat-box").append(courseMessageHTML);

	  const $courseMessage = $(".course-message").last();
	  const $productList = $courseMessage.find(".product-list");
	  addBotMessage("ì¶”ì²œëœ ê°•ì˜ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤!");
	  

	  data.forEach((course, idx) => {
		  console.log(course);
		  const title = course.title;
		  const rating = course.rating;
		  const positive = course.positive;
		  const thumbnail = course.thumbnail;
		  const courseidx = course.courseidx;

	    const card = `
	      <div class="one-product">
	        <div class="thumb">
	        <a href="/lecture_one?idx=${course.courseidx}"></a>
	          <img src="${course.thumbnail}" alt="">
	        </div>
	        <div class="info">
	          <div class="title">${course.title}</div>
	          <div class="sub">
	            <div class="date">í‰ì  : ${course.rating}</div>
	            <div class="positive">ğŸ‘  ${course.positive}%</div>
	          </div>
	        </div>
	      </div>`;
	    $productList.append(card);

	    getCourseIdxByTitle(title, function (courseIdx) {
	      if (!courseIdx) return;
	      saveRecommendation(prefIdx, courseIdx);
	    });
	  });

	  // ìŠ¬ë¼ì´ë” ìƒˆë¡œ ì´ˆê¸°í™”
	  try {
	    const slyInstance = new Sly($courseMessage[0], {
	      horizontal: 1,
	      mouseDragging: 1,
	      touchDragging: 1
	    });
	    slyInstance.init();
	    console.log("ìƒˆ Sly ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” ì„±ê³µ");
	  } catch (e) {
	    console.warn("Sly ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” ì‹¤íŒ¨", e);
	  }

	  // ì±—ë´‡ ì•ˆë‚´ ë° ë²„íŠ¼
	  addBotMessage("ë” ìì„¸í•œ ì¶”ì²œì„ ì›í•˜ì‹œë©´ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ë‹¤ì‹œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
	  const footerBtns = `
	    <div class="quick-buttons">
	      <button class="quick-button" onclick="startCategoryFlow()">ì¹´í…Œê³ ë¦¬ ì„ íƒí•˜ê¸°</button>
	      <button class="quick-button" onclick="unlockInput()">ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
	    </div>`;
	  $("#chat-box").append(footerBtns);
	  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
	}

function saveRecommendation(prefIdx, courseIdx) {
	
	
	 const userId = $("#user_id").val().trim();
	  $.ajax({
	    url: "/chatbot/recommend/one",
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      userId: userId,
	      prefIdx: prefIdx,
	      courseIdx: courseIdx,
	      recommended: "1"
	    }),
	    success: () => console.log("ì¶”ì²œ ì €ì¥ ì„±ê³µ:", courseIdx),
	    error: () => console.error("âŒ ì¶”ì²œ ì €ì¥ ì‹¤íŒ¨:", courseIdx)
	  });
	}
	
$(document).ready(function () {
	  $("#user-input").prop("disabled", true); // ì ê¸ˆ ìƒíƒœ
	});
</script>

</body>
</html>